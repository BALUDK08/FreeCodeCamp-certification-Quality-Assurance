<div class="challenge-instructions"><div><section id="description">
<p>Currently, you cannot determine who is connected to your web socket. While <code>req.user</code> contains the user object, that's only when your user interacts with the web server, and with web sockets you have no <code>req</code> (request) and therefore no user data. One way to solve the problem of knowing who is connected to your web socket is by parsing and decoding the cookie that contains the passport session then deserializing it to obtain the user object. Luckily, there is a package on NPM just for this that turns a once complex task into something simple!</p>
<p><code>passport.socketio@~3.7.0</code>, <code>connect-mongo@~3.2.0</code>, and <code>cookie-parser@~1.4.5</code> have already been added as dependencies. Require them as <code>passportSocketIo</code>, <code>MongoStore</code>, and <code>cookieParser</code> respectively. Also, we need to initialize a new memory store, from <code>express-session</code> which we previously required. It should look like this:</p>
<pre class="language-js" tabindex="0"><code class="language-js"><span class="token keyword">const</span> MongoStore <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'connect-mongo'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">URI</span> <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGO_URI</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">url</span><span class="token operator">:</span> <span class="token constant">URI</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Now we just have to tell Socket.IO to use it and set the options. Be sure this is added before the existing socket code and not in the existing connection listener. For your server, it should look like this:</p>
<pre class="language-js" tabindex="0"><code class="language-js">io<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>
  passportSocketIo<span class="token punctuation">.</span><span class="token function">authorize</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    <span class="token literal-property property">cookieParser</span><span class="token operator">:</span> cookieParser<span class="token punctuation">,</span>
    <span class="token literal-property property">key</span><span class="token operator">:</span> <span class="token string">'express.sid'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">SESSION_SECRET</span><span class="token punctuation">,</span>
    <span class="token literal-property property">store</span><span class="token operator">:</span> store<span class="token punctuation">,</span>
    <span class="token literal-property property">success</span><span class="token operator">:</span> onAuthorizeSuccess<span class="token punctuation">,</span>
    <span class="token literal-property property">fail</span><span class="token operator">:</span> onAuthorizeFail
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>Note that configuring Passport authentication for Socket.IO is very similar to the way we configured the <code>session</code> middleware for the API. This is because they are meant to use the same authentication method â€” get the session id from a cookie and validate it.</p>
<p>Previously, when we configured the <code>session</code> middleware, we didn't explicitly set the cookie name for session (<code>key</code>). This is because the <code>session</code> package was using the default value. Now that we've added another package which needs access to the same value from the cookies, we need to explicitly set the <code>key</code> value in both configuration objects.</p>
<p>Be sure to add the <code>key</code> with the cookie name to the <code>session</code> middleware that matches the Socket.IO key. Also, add the <code>store</code> reference to the options, near where we set <code>saveUninitialized: true</code>. This is necessary to tell Socket.IO which session to relate to.</p>
<hr/>
<p>Now, define the <code>success</code>, and <code>fail</code> callback functions:</p>
<pre class="language-js" tabindex="0"><code class="language-js"><span class="token keyword">function</span> <span class="token function">onAuthorizeSuccess</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> accept</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'successful connection to socket.io'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">onAuthorizeFail</span><span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> message<span class="token punctuation">,</span> error<span class="token punctuation">,</span> accept</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'failed connection to socket.io:'</span><span class="token punctuation">,</span> message<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>The user object is now accessible on your socket object as <code>socket.request.user</code>. For example, now you can add the following:</p>
<pre class="language-js" tabindex="0"><code class="language-js">console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'user '</span> <span class="token operator">+</span> socket<span class="token punctuation">.</span>request<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name <span class="token operator">+</span> <span class="token string">' connected'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<p>It will log to the server console who has connected!</p>
<p>Submit your page when you think you've got it right. If you're running into errors, you can check out the project up to this point <a href="https://gist.github.com/camperbot/1414cc9433044e306dd7fd0caa1c6254" rel="noopener noreferrer nofollow" target="_blank">https://gist.github.com/camperbot/1414cc9433044e306dd7fd0caa1c6254</a>.</p>
</section></div><hr/></div>